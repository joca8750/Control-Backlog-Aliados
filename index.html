<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard Regional - Backlog</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --rojo: #D32F2F; --gris-fondo: #F4F7F6; --texto: #212121; --borde: #dfe6e9; --azul: #1976D2; --verde: #2e7d32; }
        * { box-sizing: border-box; font-family: 'Roboto', sans-serif !important; }
        body { background: var(--gris-fondo); margin: 0; padding: 10px; color: var(--texto); overflow-x: hidden; }
        h1 { text-transform: uppercase; color: var(--rojo); text-align: center; font-size: 1rem; margin: 5px 0; font-weight: 700; }
        h2 { color: var(--rojo); font-size: 0.75rem; margin: 0 0 8px 0; text-transform: uppercase; text-align: center; font-weight: 700; }

        /* BARRA DE HERRAMIENTAS */
        .toolbar { background: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .filter-group { display: flex; flex-direction: column; gap: 2px; flex-grow: 1; min-width: 100px; }
        label { font-size: 0.55rem; color: #777; text-transform: uppercase; font-weight: 700; padding-left: 2px; }
        select { padding: 4px 8px; border-radius: 4px; border: 1px solid var(--borde); font-size: 0.7rem; background: #fff; height: 30px; cursor: pointer; }

        .btn-container { display: flex; gap: 6px; width: 100%; justify-content: center; margin-top: 5px; }
        .btn { padding: 6px 15px; border-radius: 4px; border: none; color: white; text-transform: uppercase; font-size: 0.6rem; cursor: pointer; font-weight: 700; display: flex; align-items: center; gap: 5px; }
        .btn-excel { background: var(--verde); } .btn-search { background: var(--azul); } .btn-return { background: #34495e; }

        /* KPI COMPACTOS */
        .resumen-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 10px; }
        .card { background: white; padding: 6px 4px; border-radius: 8px; border-top: 3px solid var(--rojo); text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .card h3 { color: #888; font-size: 0.55rem; margin: 0; text-transform: uppercase; }
        .card p { font-size: 1rem; color: var(--rojo); margin: 2px 0; font-weight: 700; }

        /* GRID */
        .dashboard-grid { display: flex; flex-direction: column; gap: 12px; }
        .chart-container, .tabla-critica { background: white; padding: 12px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .chart-box { height: 220px; position: relative; }

        /* TABLA */
        .table-wrapper { overflow-x: auto; max-height: 450px; border-radius: 8px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; min-width: 1100px; table-layout: fixed; }
        th { border-bottom: 2px solid var(--rojo); padding: 10px 6px; text-align: left; font-size: 0.65rem; color: #666; position: sticky; top: 0; background: #fdfdfd; z-index: 10; text-transform: uppercase; }
        td { padding: 8px 6px; border-bottom: 1px solid #f1f2f6; font-size: 0.7rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        tr.selected td { background-color: #FFEBEE !important; color: var(--rojo); font-weight: 700; }
        tr:hover td { background-color: #f9f9f9; cursor: pointer; }

        #tooltip-stopper { position: fixed; display: none; background: white; border: 2px solid var(--rojo); border-radius: 8px; padding: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); z-index: 10000; max-width: 380px; pointer-events: none; font-size: 0.8rem; }
        
        @media (min-width: 1024px) {
            body { padding: 15px 25px; height: 100vh; overflow: hidden; }
            .resumen-container { grid-template-columns: repeat(5, 1fr); }
            .dashboard-grid { display: grid; grid-template-columns: 1fr 2.5fr; height: calc(100vh - 210px); gap: 15px; }
        }
    </style>
</head>
<body>

    <h1>Backlog Regional</h1>
    <div id="tooltip-stopper"></div>

    <div class="toolbar">
        <div class="filter-group"><label>Reg</label><select id="f-regional" onchange="registrarYFiltrar()"></select></div>
        <div class="filter-group"><label>Depto</label><select id="f-depto" onchange="registrarYFiltrar()"></select></div>
        <div class="filter-group"><label>Aliado</label><select id="f-aliado" onchange="registrarYFiltrar()"></select></div>
        <div class="filter-group"><label>Topol</label><select id="f-topologia" onchange="registrarYFiltrar()"></select></div>
        <div class="filter-group"><label>Op</label><select id="f-tipo-operacion" onchange="registrarYFiltrar()"></select></div>
        <div class="btn-container">
            <button class="btn btn-search" onclick="buscarPorID()">üîç Buscar ID</button>
            <button class="btn btn-excel" onclick="exportarExcel()">üì• Excel</button>
            <button class="btn btn-return" id="btn-return" onclick="pasoAtras()" disabled>‚Ü∫ Return</button>
        </div>
    </div>

    <div class="resumen-container">
        <div class="card"><h3>Total Sitios</h3><p id="t-sitios">0</p></div>
        <div class="card"><h3>Disponibilidad</h3><p id="d-global">0%</p></div>
        <div class="card"><h3>En Falla</h3><p id="t-falla">0</p></div>
        <div class="card"><h3>Prom. Horas</h3><p id="m-promedio">0h</p></div>
        <div class="card"><h3>Prom. D√≠as</h3><p id="d-promedio">0d</p></div>
    </div>

    <div class="dashboard-grid">
        <div class="chart-container">
            <h2>ESTADO CD</h2>
            <div class="chart-box"><canvas id="cEstadoOp"></canvas></div>
        </div>
        
        <div class="tabla-critica">
            <h2 id="table-title">Backlog Activo</h2>
            <div class="table-wrapper">
                <table id="tSitios">
                    <thead><tr>
                        <th style="width:75px">ID</th>
                        <th style="width:110px">ALIADO</th>
                        <th style="width:65px; text-align:right; color:var(--rojo);">D√çAS</th>
                        <th style="width:70px; text-align:right; color:var(--azul);">HORAS</th>
                        <th style="width:180px">STOPPER / GESTI√ìN</th>
                        <th style="width:100px">OT</th>
                        <th>DETALLE PERFIL VELOCIDAD</th>
                    </tr></thead>
                    <tbody id="b-tabla"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let dataFull = []; let chartEstado; let selectedId = null; let historial = []; let currentEstadoFilter = null;
        const filtrosIds = {'f-regional': 'REGIONAL', 'f-depto': 'DEPARTAMENTO', 'f-aliado': 'ALIADO', 'f-topologia': 'TOPOLOGIA', 'f-tipo-operacion': 'PROYECTO'};

        async function init() {
            try { const res = await fetch('data_ben.json'); dataFull = await res.json(); actualizarSelectores(); aplicarCambios(false); } catch (e) { console.error(e); }
        }

        function showTooltip(e, item) {
            const tt = document.getElementById('tooltip-stopper');
            tt.innerHTML = `<b style="color:var(--rojo);">ID: ${item.ID} | ${item.MUNICIPIO}</b><br>D√≠as: ${(item.mttr_horas/24).toFixed(1)} | Horas: ${item.mttr_horas}h<br>ESTADO: <b>${item.ESTADO_OP}</b><br>GESTI√ìN: <b>${item.STOPPER}</b>`;
            tt.style.display = 'block'; tt.style.left = (e.clientX + 15) + 'px'; tt.style.top = (e.clientY + 15) + 'px';
        }
        function hideTooltip() { document.getElementById('tooltip-stopper').style.display = 'none'; }

        function registrarEstado() {
            const estado = { filtros: {}, selectedId, currentEstadoFilter };
            for (let id in filtrosIds) estado.filtros[id] = document.getElementById(id).value;
            historial.push(JSON.stringify(estado));
            document.getElementById('btn-return').disabled = false;
        }

        function registrarYFiltrar() { currentEstadoFilter = null; selectedId = null; registrarEstado(); aplicarCambios(false); }

        function aplicarCambios(conReg = true) {
            if (conReg) registrarEstado();
            const sel = {}; for (let id in filtrosIds) sel[filtrosIds[id]] = document.getElementById(id).value;
            let filtered = dataFull.filter(i => {
                if (sel.REGIONAL !== 'todos' && i.REGIONAL !== sel.REGIONAL) return false;
                if (sel.DEPARTAMENTO !== 'todos' && i.DEPARTAMENTO !== sel.DEPARTAMENTO) return false;
                if (sel.ALIADO !== 'todos' && i.ALIADO !== sel.ALIADO) return false;
                if (sel.TOPOLOGIA !== 'todos' && i.TOPOLOGIA !== sel.TOPOLOGIA) return false;
                if (sel.PROYECTO !== 'todos' && i.PROYECTO !== sel.PROYECTO) return false;
                if (currentEstadoFilter && i.ESTADO_OP !== currentEstadoFilter) return false;
                return i.tickets > 0;
            });
            if (selectedId) filtered = filtered.filter(i => i.ID == selectedId);
            actualizarSelectores(); render(filtered);
        }

        function render(data) {
            const sorted = data.sort((a, b) => b.mttr_horas - a.mttr_horas);
            let sD = 0, sH = 0, nF = sorted.length, mE = {};
            dataFull.forEach(s => sD += s.disponibilidad);
            sorted.forEach(s => { sH += s.mttr_horas; mE[s.ESTADO_OP] = (mE[s.ESTADO_OP] || 0) + 1; });

            document.getElementById('t-sitios').innerText = dataFull.length;
            document.getElementById('d-global').innerText = (sD / (dataFull.length || 1)).toFixed(0) + "%";
            document.getElementById('t-falla').innerText = nF;
            document.getElementById('m-promedio').innerText = (sH / (nF || 1)).toFixed(0) + "h";
            document.getElementById('d-promedio').innerText = (sH / (nF || 1) / 24).toFixed(1) + "d";

            const tb = document.getElementById('b-tabla'); tb.innerHTML = "";
            sorted.forEach(s => {
                const tr = document.createElement('tr'); if (s.ID == selectedId) tr.className = 'selected';
                tr.onmouseenter = (e) => showTooltip(e, s); tr.onmouseleave = hideTooltip;
                tr.onclick = () => { registrarEstado(); selectedId = s.ID; aplicarCambios(false); };
                tr.innerHTML = `<td>${s.ID}</td><td>${s.ALIADO}</td><td style="text-align:right; font-weight:700; color:var(--rojo);">${(s.mttr_horas/24).toFixed(1)}</td><td style="text-align:right; color:var(--azul);">${s.mttr_horas}</td><td>${s.STOPPER || "N/A"}</td><td>${s.OT_REL || "N/A"}</td><td>${s.PERFIL || "N/A"}</td>`;
                tb.appendChild(tr);
            });
            document.getElementById('table-title').innerText = currentEstadoFilter ? `ESTADO: ${currentEstadoFilter} (${nF})` : `Backlog Activo (${nF})`;
            actChart(mE);
        }

        function actChart(estados) {
            if(chartEstado) chartEstado.destroy();
            const isMob = window.innerWidth < 1024;
            chartEstado = new Chart(document.getElementById('cEstadoOp'), {
                type: 'doughnut', data: { labels: Object.keys(estados), datasets: [{ data: Object.values(estados), backgroundColor: ['#D32F2F', '#1565C0', '#2E7D32', '#F9A825', '#6A1B9A', '#EF6C00'] }] },
                options: { 
                    maintainAspectRatio: false, 
                    plugins: { legend: { position: isMob ? 'bottom' : 'right', labels: { boxWidth: 10, font: { size: 9 } } }},
                    onClick: (e, el) => {
                        if (el.length > 0) {
                            const index = el[0].index;
                            currentEstadoFilter = chartEstado.data.labels[index];
                            registrarEstado();
                            aplicarCambios(false);
                        }
                    }
                }
            });
        }

        function buscarPorID() {
            const id = prompt("Ingrese ID:");
            if (id) { const s = dataFull.find(i => String(i.ID) === id.trim()); if (s) { registrarEstado(); selectedId = s.ID; aplicarCambios(false); } }
        }

        function pasoAtras() {
            if (historial.length > 0) {
                const u = JSON.parse(historial.pop());
                for (let id in u.filtros) document.getElementById(id).value = u.filtros[id];
                selectedId = u.selectedId; currentEstadoFilter = u.currentEstadoFilter;
                aplicarCambios(false);
                if (historial.length === 0) document.getElementById('btn-return').disabled = true;
            }
        }

        function actualizarSelectores() {
            const act = {}; for (let id in filtrosIds) act[id] = document.getElementById(id).value;
            for (let target in filtrosIds) {
                const unicos = [...new Set(dataFull.filter(i => {
                    for (let s in filtrosIds) { if (s !== target && act[s] !== 'todos' && i[filtrosIds[s]] !== act[s]) return false; }
                    return true;
                }).map(i => i[filtrosIds[target]]))].filter(v => v && v !== "N/A").sort();
                const el = document.getElementById(target); const prev = act[target];
                el.innerHTML = '<option value="todos">Todos</option>';
                unicos.forEach(v => el.add(new Option(v, v))); if (unicos.includes(prev)) el.value = prev;
            }
        }

        function exportarExcel() { XLSX.writeFile(XLSX.utils.table_to_book(document.getElementById('tSitios')), "Reporte_Estado_Filtrado.xlsx"); }
        init();
    </script>
</body>
</html>