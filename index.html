<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard R3 - Backlog Aliados</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --rojo: #D32F2F; 
            --gris-fondo: #F4F7F6; 
            --texto: #212121; 
        }

        /* RESET GLOBAL: TODO EN ROBOTO, SIN NEGRILLA, SIN CURSIVA */
        * {
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif !important;
            font-weight: 400 !important;
            font-style: normal !important;
            -webkit-font-smoothing: antialiased;
        }

        body { 
            background: var(--gris-fondo); 
            margin: 0; 
            padding: 10px 20px; 
            color: var(--texto); 
            height: 100vh;
            overflow: hidden; 
        }

        /* TÍTULO PRINCIPAL CENTRADO */
        h1 { 
            text-transform: uppercase; 
            color: var(--rojo); 
            letter-spacing: 1px; 
            text-align: center;
            font-size: 2.2rem; 
            margin: 15px 0; 
        }

        /* TÍTULOS DE SECCIONES CENTRADOS */
        h2 { 
            color: var(--rojo); 
            font-size: 1.2rem; 
            margin: 0 0 10px 0; 
            text-transform: uppercase;
            text-align: center;
        }

        /* BARRA DE FILTROS */
        .toolbar { 
            background: white; 
            padding: 10px 20px; 
            border-radius: 8px; 
            margin-bottom: 15px; 
            display: flex; 
            flex-wrap: wrap;
            gap: 15px; 
            align-items: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        }

        .filter-group { display: flex; align-items: center; gap: 8px; }

        label { font-size: 0.85rem; color: #555; text-transform: uppercase; }

        select { 
            padding: 6px 10px; 
            border-radius: 4px; 
            border: 1px solid #ddd; 
            font-size: 0.85rem;
            min-width: 150px; 
            background: #fff;
            outline: none;
        }

        /* TARJETAS KPI */
        .resumen-container { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 15px; 
            margin-bottom: 15px; 
        }

        .card { 
            background: white; 
            padding: 15px; 
            border-radius: 8px; 
            border-top: 2px solid var(--rojo); 
            text-align: center; 
            box-shadow: 0 3px 6px rgba(0,0,0,0.05); 
        }

        .card h3 { color: #666; font-size: 0.85rem; margin: 0; text-transform: uppercase; }
        .card p { font-size: 2rem; color: var(--rojo); margin: 5px 0; }

        /* GRID DEL DASHBOARD (UNA SOLA PÁGINA) */
        .dashboard-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1.5fr; 
            gap: 15px; 
            height: calc(100vh - 270px); 
        }

        .chart-container, .tabla-critica { 
            background: white; 
            padding: 15px; 
            border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .table-wrapper { overflow-y: auto; flex-grow: 1; }

        /* TABLA */
        table { width: 100%; border-collapse: collapse; }
        th { 
            border-bottom: 1px solid var(--rojo); 
            padding: 10px; 
            text-align: left; 
            font-size: 0.8rem; 
            text-transform: uppercase;
            color: #888;
            position: sticky;
            top: 0;
            background: white;
            z-index: 5;
        }
        td { padding: 8px 10px; border-bottom: 1px solid #eee; font-size: 0.85rem; color: var(--texto); }
        tr:hover { background: #f9f9f9; }

        /* BOTÓN EXCEL */
        .btn-excel { 
            background: var(--rojo); 
            color: white; 
            border: none; 
            padding: 8px 18px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 0.85rem; 
            text-transform: uppercase;
            margin-left: auto;
        }

        @media (max-width: 1100px) {
            .dashboard-grid { grid-template-columns: 1fr; overflow-y: auto; height: auto; }
            body { overflow-y: auto; height: auto; }
            .resumen-container { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

    <h1>Panel de Control Backlog Aliados: R3</h1>

    <div class="toolbar">
        <div class="filter-group">
            <label>Regional</label>
            <select id="f-regional" onchange="filtrar()"><option value="todos">Todos</option></select>
        </div>
        <div class="filter-group">
            <label>Depto</label>
            <select id="f-depto" onchange="filtrar()"><option value="todos">Todos</option></select>
        </div>
        <div class="filter-group">
            <label>Aliado</label>
            <select id="f-aliado" onchange="filtrar()"><option value="todos">Todos</option></select>
        </div>
        <div class="filter-group">
            <label>Topología</label>
            <select id="f-topologia" onchange="filtrar()"><option value="todos">Todos</option></select>
        </div>
        <button class="btn-excel" onclick="exportarExcel()">Descargar Excel</button>
    </div>

    <div class="resumen-container">
        <div class="card"><h3>Disponibilidad</h3><p id="d-global">0%</p></div>
        <div class="card"><h3>Sitios Falla</h3><p id="t-falla">0</p></div>
        <div class="card"><h3>Promedio Horas</h3><p id="m-promedio">0h</p></div>
        <div class="card"><h3>Sede Crítica</h3><p id="s-critico" style="font-size: 0.85rem;">--</p></div>
    </div>

    <div class="dashboard-grid">
        <div class="chart-container">
            <h2>Distribución</h2>
            <div style="flex-grow:1;"><canvas id="cFallas"></canvas></div>
        </div>
        <div class="chart-container">
            <h2>Ranking Aliados</h2>
            <div style="flex-grow:1;"><canvas id="cAliados"></canvas></div>
        </div>
        <div class="tabla-critica">
            <h2>Lista de Backlog</h2>
            <div class="table-wrapper">
                <table id="tSitios">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Aliado</th>
                            <th>Estado</th>
                            <th>Hrs</th>
                        </tr>
                    </thead>
                    <tbody id="b-tabla"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let dataFull = [];
        let chart1, chart2;

        Chart.defaults.font.family = 'Roboto';
        Chart.defaults.font.weight = '400';
        Chart.defaults.font.size = 11;

        async function init() {
            try {
                const res = await fetch('data_ben.json');
                dataFull = await res.json();
                actualizarFiltrosCascada(dataFull, true);
                render(dataFull);
            } catch (e) { console.error("Error cargando JSON", e); }
        }

        function actualizarFiltrosCascada(data, inicial = false) {
            const config = {
                'f-regional': 'REGIONAL',
                'f-depto': 'DEPARTAMENTO',
                'f-aliado': 'ALIADO',
                'f-topologia': 'TOPOLOGIA'
            };

            for (let id in config) {
                const el = document.getElementById(id);
                const valorPrevio = el.value;
                const campo = config[id];

                // Solo actualizamos los filtros que NO son el que el usuario acaba de tocar
                // (O todos si es la carga inicial)
                const uniqueValues = [...new Set(data.map(i => i[campo]))]
                    .filter(v => v && v !== "N/A" && v !== "undefined")
                    .sort();

                el.innerHTML = '<option value="todos">Todos</option>';
                uniqueValues.forEach(v => {
                    el.add(new Option(v, v));
                });

                if (!inicial && [...el.options].some(o => o.value === valorPrevio)) {
                    el.value = valorPrevio;
                }
            }
        }

        function filtrar() {
            const fRegional = document.getElementById('f-regional').value;
            const fDepto = document.getElementById('f-depto').value;
            const fAliado = document.getElementById('f-aliado').value;
            const fTopologia = document.getElementById('f-topologia').value;

            const filtrados = dataFull.filter(i => {
                return (fRegional === "todos" || i.REGIONAL === fRegional) &&
                       (fDepto === "todos" || i.DEPARTAMENTO === fDepto) &&
                       (fAliado === "todos" || i.ALIADO === fAliado) &&
                       (fTopologia === "todos" || i.TOPOLOGIA === fTopologia);
            });

            // Si el usuario cambia la Regional, actualizamos las opciones de los otros filtros
            actualizarFiltrosCascada(filtrados);
            render(filtrados);
        }

        function render(data) {
            let sDisp = 0, tFallas = 0, sMTTR = 0;
            let causas = {}, rankingAliados = {};
            const tbody = document.getElementById('b-tabla');
            tbody.innerHTML = "";

            data.forEach(s => {
                sDisp += s.disponibilidad;
                if(s.tickets > 0) tFallas++;
                sMTTR += s.mttr_horas;
                causas[s.motivo_falla] = (causas[s.motivo_falla] || 0) + 1;
                rankingAliados[s.ALIADO] = (rankingAliados[s.ALIADO] || 0) + (s.tickets > 0 ? 1 : 0);

                if(s.disponibilidad < 100) {
                    tbody.innerHTML += `<tr>
                        <td>${s.ID}</td>
                        <td>${s.ALIADO}</td>
                        <td>${s.motivo_falla}</td>
                        <td style="color:var(--rojo)">${s.mttr_horas.toFixed(1)}h</td>
                    </tr>`;
                }
            });

            document.getElementById('d-global').innerText = (data.length > 0 ? sDisp / data.length : 0).toFixed(1) + "%";
            document.getElementById('t-falla').innerText = tFallas;
            document.getElementById('m-promedio').innerText = (data.length > 0 ? sMTTR / data.length : 0).toFixed(1) + "h";
            
            const critico = data.length > 0 ? data.reduce((p, c) => (p.mttr_horas > c.mttr_horas) ? p : c) : null;
            document.getElementById('s-critico').innerText = critico ? critico['ID'] : "--";

            if(chart1) chart1.destroy();
            if(chart2) chart2.destroy();

            chart1 = new Chart(document.getElementById('cFallas'), { 
                type: 'doughnut', 
                data: { labels: Object.keys(causas), datasets: [{ data: Object.values(causas), backgroundColor: ['#D32F2F', '#546E7A', '#90A4AE', '#CFD8DC'], borderWidth: 0 }] },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });

            chart2 = new Chart(document.getElementById('cAliados'), { 
                type: 'bar', 
                data: { labels: Object.keys(rankingAliados), datasets: [{ label: 'Fallas', data: Object.values(rankingAliados), backgroundColor: '#D32F2F' }] },
                options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
        }

        function exportarExcel() { XLSX.writeFile(XLSX.utils.table_to_book(document.getElementById('tSitios')), "Reporte_R3.xlsx"); }
        init();
    </script>
</body>
</html>