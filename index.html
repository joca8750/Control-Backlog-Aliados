<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Backlog Regionales - Fixed View</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --rojo: #D32F2F; 
            --gris-fondo: #F4F7F6; 
            --texto: #212121; 
            --borde: #E0E0E0;
            --azul-return: #2c3e50;
        }

        * { box-sizing: border-box; font-family: 'Roboto', sans-serif !important; }
        
        /* Ajuste base para evitar cortes */
        html, body { height: 100%; margin: 0; padding: 0; background: var(--gris-fondo); }
        
        body { display: flex; flex-direction: column; padding: 10px; overflow-x: hidden; }

        h1 { text-transform: uppercase; color: var(--rojo); text-align: center; font-size: 1.2rem; margin: 5px 0; }

        /* TOOLBAR */
        .toolbar { 
            background: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; 
            display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
        }
        .filter-group { display: flex; flex-direction: column; flex-grow: 1; min-width: 100px; }
        label { font-size: 0.6rem; color: #666; text-transform: uppercase; margin-bottom: 2px; }
        select { padding: 5px; border-radius: 4px; border: 1px solid var(--borde); font-size: 0.75rem; height: 30px; }

        .btn-container { display: flex; gap: 5px; margin-top: 5px; width: 100%; justify-content: center; }
        .btn { padding: 8px 15px; border-radius: 4px; border: none; color: white; text-transform: uppercase; font-size: 0.7rem; cursor: pointer; font-weight: 500; }
        .btn-excel { background: var(--rojo); }
        .btn-return { background: var(--azul-return); }
        .btn:disabled { opacity: 0.3; }

        /* KPI CARDS */
        .resumen-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 10px; }
        .card { background: white; padding: 8px; border-radius: 6px; border-top: 2px solid var(--rojo); text-align: center; }
        .card h3 { color: #777; font-size: 0.6rem; margin: 0; text-transform: uppercase; }
        .card p { font-size: 1.3rem; color: var(--rojo); margin: 2px 0; font-weight: 500; }

        /* DASHBOARD GRID */
        .dashboard-grid { 
            display: flex; flex-direction: column; gap: 10px; flex-grow: 1; 
        }

        /* CONTENEDORES DE GRÁFICAS (Forzamos altura) */
        .chart-container { 
            background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            min-height: 250px; /* Asegura que no desaparezcan */
        }
        .chart-box { height: 220px; width: 100%; position: relative; }

        /* TABLA CON SCROLL REAL */
        .tabla-critica { 
            background: white; padding: 10px; border-radius: 8px; 
            display: flex; flex-direction: column; min-height: 300px;
        }
        .table-wrapper { 
            flex-grow: 1;
            overflow-y: auto; /* Scroll vertical */
            overflow-x: auto; /* Scroll horizontal para móvil */
            border: 1px solid #eee;
            margin-top: 5px;
        }
        
        table { width: 100%; border-collapse: collapse; min-width: 400px; table-layout: fixed; }
        th { border-bottom: 2px solid var(--rojo); padding: 8px; text-align: left; font-size: 0.7rem; position: sticky; top: 0; background: white; z-index: 10; }
        td { padding: 10px 8px; border-bottom: 1px solid #f5f5f5; font-size: 0.75rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        tr.selected td { background-color: #FFEBEE !important; color: var(--rojo); font-weight: 500; border-left: 3px solid var(--rojo); }

        /* RESPONSIVO PARA PC */
        @media (min-width: 1024px) {
            body { height: 100vh; overflow: hidden; padding: 10px 20px; }
            .toolbar { flex-wrap: nowrap; }
            .btn-container { width: auto; margin-top: 0; }
            .resumen-container { grid-template-columns: repeat(4, 1fr); }
            .dashboard-grid { 
                display: grid; grid-template-columns: 1fr 1fr 1.5fr; 
                height: calc(100vh - 220px); 
            }
            .chart-container { min-height: auto; height: 100%; }
            .chart-box { height: calc(100% - 30px); }
            .tabla-critica { height: 100%; min-height: auto; }
        }
    </style>
</head>
<body>

    <h1>Backlog Regionales</h1>

    <div class="toolbar">
        <div class="filter-group"><label>Reg</label><select id="f-regional" onchange="registrarYFiltrar()"></select></div>
        <div class="filter-group"><label>Depto</label><select id="f-depto" onchange="registrarYFiltrar()"></select></div>
        <div class="filter-group"><label>Aliado</label><select id="f-aliado" onchange="registrarYFiltrar()"></select></div>
        <div class="filter-group"><label>Topol</label><select id="f-topologia" onchange="registrarYFiltrar()"></select></div>
        <div class="filter-group"><label>Op</label><select id="f-tipo-operacion" onchange="registrarYFiltrar()"></select></div>
        <div class="filter-group"><label>Causa</label><select id="f-causa" onchange="registrarYFiltrar()"></select></div>
        <div class="btn-container">
            <button class="btn btn-excel" onclick="exportarExcel()">Excel</button>
            <button class="btn btn-return" id="btn-return" onclick="pasoAtras()" disabled>Return</button>
        </div>
    </div>

    <div class="resumen-container">
        <div class="card"><h3>Disponibilidad</h3><p id="d-global">0%</p></div>
        <div class="card"><h3>Sitios Falla</h3><p id="t-falla">0</p></div>
        <div class="card"><h3>Prom. Horas</h3><p id="m-promedio">0h</p></div>
        <div class="card"><h3>Prom. Días</h3><p id="d-promedio">0d</p></div>
    </div>

    <div class="dashboard-grid">
        <div class="chart-container">
            <h2 id="tit-dist">Distribución</h2>
            <div class="chart-box"><canvas id="cFallas"></canvas></div>
        </div>
        <div class="chart-container">
            <h2>Ranking Aliado</h2>
            <div class="chart-box"><canvas id="cAliados"></canvas></div>
        </div>
        <div class="tabla-critica">
            <h2 id="titulo-lista">Listado de Sitios</h2>
            <div class="table-wrapper" id="scroll-container">
                <table id="tSitios">
                    <thead>
                        <tr>
                            <th style="width:25%">ID</th>
                            <th style="width:35%">Aliado</th>
                            <th style="width:20%; text-align:right">Dias</th>
                            <th style="width:20%; text-align:right">Hrs</th>
                        </tr>
                    </thead>
                    <tbody id="b-tabla"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let dataFull = [];
        let dataParaTabla = [];
        let chart1, chart2;
        let selectedId = null;
        let historial = [];
        let indexActual = 0;
        const pasoCarga = 50; // Cargas más pequeñas para mayor fluidez

        const filtrosIds = {'f-regional': 'REGIONAL', 'f-depto': 'DEPARTAMENTO', 'f-aliado': 'ALIADO', 'f-topologia': 'TOPOLOGIA', 'f-tipo-operacion': 'PROYECTO', 'f-causa': 'motivo_falla'};
        const coloresPaleta = ['#D32F2F', '#1976D2', '#388E3C', '#FBC02D', '#7B1FA2', '#E64A19', '#0097A7', '#5D4037', '#689F38', '#455A64'];

        async function init() {
            try {
                const res = await fetch('data_ben.json');
                dataFull = await res.json();
                actualizarSelectores();
                aplicarCambios(false);

                // Listener de scroll para cargar más datos
                document.getElementById('scroll-container').addEventListener('scroll', function() {
                    if (this.scrollTop + this.clientHeight >= this.scrollHeight - 20) {
                        cargarMasFilas();
                    }
                });
            } catch (e) { console.error("Error cargando JSON:", e); }
        }

        function registrarEstado() {
            const estado = { filtros: {}, selectedId: selectedId };
            for (let id in filtrosIds) { estado.filtros[id] = document.getElementById(id).value; }
            historial.push(JSON.stringify(estado));
            document.getElementById('btn-return').disabled = false;
        }

        function registrarYFiltrar() { registrarEstado(); aplicarCambios(false); }

        function aplicarCambios(conRegistro = true) {
            if (conRegistro) registrarEstado();
            const selecciones = {};
            let hayFiltros = false;
            for (let id in filtrosIds) { 
                const val = document.getElementById(id).value || 'todos';
                selecciones[filtrosIds[id]] = val; 
                if (val !== 'todos') hayFiltros = true;
            }
            
            const filtrados = dataFull.filter(item => {
                return (selecciones.REGIONAL === 'todos' || item.REGIONAL === selecciones.REGIONAL) &&
                       (selecciones.DEPARTAMENTO === 'todos' || item.DEPARTAMENTO === selecciones.DEPARTAMENTO) &&
                       (selecciones.ALIADO === 'todos' || item.ALIADO === selecciones.ALIADO) &&
                       (selecciones.TOPOLOGIA === 'todos' || item.TOPOLOGIA === selecciones.TOPOLOGIA) &&
                       (selecciones.PROYECTO === 'todos' || item.PROYECTO === selecciones.PROYECTO) &&
                       (selecciones.motivo_falla === 'todos' || item.motivo_falla === selecciones.motivo_falla);
            });
            
            actualizarSelectores();
            const sorted = filtrados.sort((a, b) => (parseFloat(b.mttr_horas) || 0) - (parseFloat(a.mttr_horas) || 0));
            
            // Si hay filtros mostramos todo, si no el Top 500
            dataParaTabla = hayFiltros ? sorted.filter(s => s.tickets > 0 || s.disponibilidad < 100) : sorted.filter(s => s.tickets > 0 || s.disponibilidad < 100).slice(0, 500);
            
            render(filtrados, hayFiltros);
        }

        function seleccionarSitio(id) {
            registrarEstado();
            const s = dataFull.find(item => item.ID == id);
            if (!s) return;
            selectedId = id;
            for (let idInput in filtrosIds) { document.getElementById(idInput).value = s[filtrosIds[idInput]]; }
            dataParaTabla = [s];
            render([s], true);
            document.getElementById('titulo-lista').innerText = `ID: ${s.ID}`;
            if(window.innerWidth < 1024) window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function pasoAtras() {
            if (historial.length === 0) return;
            const ultimo = JSON.parse(historial.pop());
            for (let id in ultimo.filtros) { document.getElementById(id).value = ultimo.filtros[id]; }
            selectedId = ultimo.selectedId;
            actualizarSelectores();
            aplicarCambios(false);
            if (historial.length === 0) document.getElementById('btn-return').disabled = true;
        }

        function actualizarSelectores() {
            const actuales = {};
            for (let id in filtrosIds) { actuales[id] = document.getElementById(id).value || 'todos'; }
            for (let idTarget in filtrosIds) {
                const campoTarget = filtrosIds[idTarget];
                const selectEl = document.getElementById(idTarget);
                const unicos = [...new Set(dataFull.filter(item => {
                    for (let idSource in filtrosIds) {
                        if (idSource === idTarget) continue;
                        const val = actuales[idSource];
                        if (val !== 'todos' && item[filtrosIds[idSource]] !== val) return false;
                    }
                    return true;
                }).map(i => i[campoTarget]))].filter(v => v && v !== "N/A").sort();
                selectEl.innerHTML = '<option value="todos">Todos</option>';
                unicos.forEach(v => selectEl.add(new Option(v, v)));
                if (unicos.includes(actuales[idTarget])) selectEl.value = actuales[idTarget];
            }
        }

        function render(data, hayFiltros) {
            let sD = 0, sH = 0, nF = 0, mC = {}, mA = {};
            data.forEach(s => {
                sD += s.disponibilidad; sH += s.mttr_horas;
                if (s.tickets > 0) { nF++; mC[s.motivo_falla] = (mC[s.motivo_falla] || 0) + 1; mA[s.ALIADO] = (mA[s.ALIADO] || 0) + 1; }
            });
            const t = data.length || 1;
            document.getElementById('d-global').innerText = (sD / t).toFixed(1) + "%";
            document.getElementById('t-falla').innerText = nF;
            document.getElementById('m-promedio').innerText = (sH / t).toFixed(1) + "h";
            document.getElementById('d-promedio').innerText = (sH / t / 24).toFixed(1) + "d";

            const tbody = document.getElementById('b-tabla');
            tbody.innerHTML = "";
            indexActual = 0;
            cargarMasFilas();
            actualizarGraficas(mC, mA);
            if (!selectedId) document.getElementById('titulo-lista').innerText = hayFiltros ? `Resultados (${dataParaTabla.length})` : `Top 500 Críticos`;
        }

        function cargarMasFilas() {
            const tbody = document.getElementById('b-tabla');
            const fin = Math.min(indexActual + pasoCarga, dataParaTabla.length);
            for (let i = indexActual; i < fin; i++) {
                const s = dataParaTabla[i];
                const tr = document.createElement('tr');
                if (s.ID == selectedId) tr.className = 'selected';
                tr.onclick = () => seleccionarSitio(s.ID);
                const hrsLabel = s.mttr_horas === 0 && s.tickets > 0 ? "Pend." : s.mttr_horas.toFixed(1) + "h";
                tr.innerHTML = `<td>${s.ID}</td><td>${s.ALIADO}</td><td style="text-align:right;">${(s.mttr_horas/24).toFixed(1)}d</td><td style="color:var(--rojo);text-align:right;">${hrsLabel}</td>`;
                tbody.appendChild(tr);
            }
            indexActual = fin;
        }

        function actualizarGraficas(causas, ranking) {
            if(chart1) chart1.destroy(); if(chart2) chart2.destroy();
            const isMob = window.innerWidth < 1024;
            
            chart1 = new Chart(document.getElementById('cFallas'), {
                type: 'doughnut', data: { labels: Object.keys(causas), datasets: [{ data: Object.values(causas), backgroundColor: coloresPaleta, borderWidth: 0 }] },
                options: { 
                    maintainAspectRatio: false, 
                    plugins: { legend: { position: isMob ? 'bottom' : 'right', labels: { boxWidth: 8, font: { size: 9 } }, onClick: (e, item) => { registrarEstado(); document.getElementById('f-causa').value = item.text; aplicarCambios(false); } } },
                    onClick: (e, el) => { if(el.length > 0) { registrarEstado(); document.getElementById('f-causa').value = Object.keys(causas)[el[0].index]; aplicarCambios(false); }}
                }
            });

            const eA = Object.keys(ranking);
            chart2 = new Chart(document.getElementById('cAliados'), {
                type: 'bar', data: { labels: eA, datasets: [{ data: Object.values(ranking), backgroundColor: eA.map((_, i) => coloresPaleta[i % coloresPaleta.length]) }] },
                options: { 
                    maintainAspectRatio: false, layout: { padding: { bottom: 20 } }, plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { display: false }, ticks: { font: { size: 8 } } }, x: { ticks: { maxRotation: 45, minRotation: 45, font: { size: 7 }, autoSkip: false } } },
                    onClick: (e, el) => { if(el.length > 0) { registrarEstado(); document.getElementById('f-aliado').value = eA[el[0].index]; aplicarCambios(false); }}
                }
            });
        }

        function exportarExcel() { XLSX.writeFile(XLSX.utils.table_to_book(document.getElementById('tSitios')), "Reporte.xlsx"); }
        init();
    </script>
</body>
</html>