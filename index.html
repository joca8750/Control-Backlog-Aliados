<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Backlog Regional - Dashboard Premium</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --rojo: #D32F2F; 
            --gris-fondo: #F0F2F5; 
            --texto: #1C1E21; 
            --azul-return: #34495e;
            --azul-search: #007bff;
            --verde-excel: #27ae60;
            
            /* Colores de Filtros */
            --c-reg: #0077b6;
            --c-depto: #2a9d8f;
            --c-aliado: #f4a261;
            --c-topol: #9b59b6;
            --c-op: #118ab2;
            --c-causa: #e63946;
        }

        * { box-sizing: border-box; font-family: 'Roboto', sans-serif !important; }
        body { background: var(--gris-fondo); margin: 0; padding: 10px; color: var(--texto); overflow-x: hidden; }

        h1 { text-transform: uppercase; color: var(--rojo); text-align: center; font-size: 1.3rem; margin: 12px 0; letter-spacing: 1.5px; font-weight: 900; }
        h2 { color: #555; font-size: 0.85rem; margin: 0 0 10px 0; text-transform: uppercase; text-align: center; font-weight: 700; }

        /* TOOLBAR INTERACTIVA */
        .toolbar { 
            background: #ffffff; padding: 15px; border-radius: 12px; margin-bottom: 15px; 
            display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
        }

        .filter-group { display: flex; flex-direction: column; gap: 4px; flex-grow: 1; min-width: 130px; }
        .filter-group label { font-size: 0.6rem; font-weight: 800; text-transform: uppercase; padding-left: 5px; }
        
        /* Estilos Individuales de Filtros */
        #f-regional { border-left: 4px solid var(--c-reg); color: var(--c-reg); }
        .l-reg { color: var(--c-reg); }

        #f-depto { border-left: 4px solid var(--c-depto); color: var(--c-depto); }
        .l-depto { color: var(--c-depto); }

        #f-aliado { border-left: 4px solid var(--c-aliado); color: var(--c-aliado); }
        .l-aliado { color: var(--c-aliado); }

        #f-topologia { border-left: 4px solid var(--c-topol); color: var(--c-topol); }
        .l-topol { color: var(--c-topol); }

        #f-tipo-operacion { border-left: 4px solid var(--c-op); color: var(--c-op); }
        .l-op { color: var(--c-op); }

        #f-causa { border-left: 4px solid var(--c-causa); color: var(--c-causa); }
        .l-causa { color: var(--c-causa); }

        select { 
            padding: 6px 10px; border-radius: 8px; border: 1px solid #e0e0e0; font-size: 0.75rem; 
            background: #fff; width: 100%; height: 36px; cursor: pointer; font-weight: 600;
            transition: all 0.3s ease; appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"><path fill="%23888" d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat; background-position: right 10px center;
        }

        select:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-color: #bbb; }
        select:focus { outline: none; border-color: #888; background-color: #f9f9f9; }

        /* BOTONES */
        .btn-container { display: flex; gap: 10px; width: 100%; justify-content: center; margin-top: 5px; }
        .btn { 
            padding: 10px 20px; border-radius: 8px; border: none; color: white; text-transform: uppercase; 
            font-size: 0.7rem; cursor: pointer; display: flex; align-items: center; gap: 8px; 
            font-weight: 700; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        .btn:hover { transform: scale(1.05); filter: brightness(1.1); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn:active { transform: scale(0.95); }
        
        .btn-excel { background: var(--verde-excel); }
        .btn-search { background: var(--azul-search); }
        .btn-return { background: var(--azul-return); }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none !important; }

        /* KPIs */
        .resumen-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
        .card { background: white; padding: 10px; border-radius: 12px; border-top: 4px solid var(--rojo); text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.04); transition: 0.3s; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0,0,0,0.08); }
        .card h3 { color: #888; font-size: 0.6rem; margin: 0; text-transform: uppercase; letter-spacing: 0.5px; }
        .card p { font-size: 1.3rem; color: var(--rojo); margin: 4px 0; font-weight: 900; }

        /* DASHBOARD */
        .dashboard-grid { display: flex; flex-direction: column; gap: 15px; }
        .chart-container, .tabla-critica { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        
        .table-wrapper { overflow-x: auto; max-height: 450px; border-radius: 8px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 700px; table-layout: fixed; }
        th { border-bottom: 2px solid var(--rojo); padding: 10px 8px; text-align: left; font-size: 0.65rem; color: #999; position: sticky; top: 0; background: white; z-index: 10; text-transform: uppercase; }
        td { padding: 10px 8px; border-bottom: 1px solid #f0f0f0; font-size: 0.75rem; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }

        tr.selected td { background-color: #fff5f5 !important; color: var(--rojo); font-weight: 700; border-left: 4px solid var(--rojo); }
        tr:hover td { background-color: #fcfcfc; cursor: pointer; }

        #tooltip-stopper {
            position: fixed; display: none; background: #ffffff; border: 2px solid var(--rojo); border-radius: 10px;
            padding: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); z-index: 10000; max-width: 380px;
            pointer-events: none; font-size: 0.9rem; color: #333; line-height: 1.4;
        }

        @media (min-width: 1024px) {
            body { padding: 15px 25px; height: 100vh; overflow: hidden; }
            .resumen-container { grid-template-columns: repeat(5, 1fr); }
            .dashboard-grid { display: grid; grid-template-columns: 1fr 1.2fr 1.8fr; height: calc(100vh - 240px); align-items: start; gap: 20px; }
            .btn-container { width: auto; margin-top: 0; }
        }
    </style>
</head>
<body>

    <h1>Backlog Regional</h1>
    <div id="tooltip-stopper"></div>

    <div class="toolbar">
        <div class="filter-group"><label class="l-reg">Reg</label><select id="f-regional" onchange="registrarYFiltrar()"></select></div>
        <div class="filter-group"><label class="l-depto">Depto</label><select id="f-depto" onchange="registrarYFiltrar()"></select></div>
        <div class="filter-group"><label class="l-aliado">Aliado</label><select id="f-aliado" onchange="registrarYFiltrar()"></select></div>
        <div class="filter-group"><label class="l-topol">Topol</label><select id="f-topologia" onchange="registrarYFiltrar()"></select></div>
        <div class="filter-group"><label class="l-op">Op</label><select id="f-tipo-operacion" onchange="registrarYFiltrar()"></select></div>
        <div class="filter-group"><label class="l-causa">Causa</label><select id="f-causa" onchange="registrarYFiltrar()"></select></div>
        
        <div class="btn-container">
            <button class="btn btn-search" onclick="buscarPorID()">üîç Buscar ID</button>
            <button class="btn btn-excel" onclick="exportarExcel()">üì• Descargar</button>
            <button class="btn btn-return" id="btn-return" onclick="pasoAtras()" disabled>‚Ü∫ Volver</button>
        </div>
    </div>

    <div class="resumen-container">
        <div class="card"><h3>Total Sitios</h3><p id="t-sitios">0</p></div>
        <div class="card"><h3>Disponibilidad</h3><p id="d-global">0%</p></div>
        <div class="card"><h3>Sitios Falla</h3><p id="t-falla">0</p></div>
        <div class="card"><h3>Hrs Promedio</h3><p id="m-promedio">0h</p></div>
        <div class="card"><h3>D√≠as Promedio</h3><p id="d-promedio">0d</p></div>
    </div>

    <div class="dashboard-grid">
        <div class="chart-container"><h2>Distribuci√≥n Fallas</h2><div class="chart-box"><canvas id="cFallas"></canvas></div></div>
        <div class="chart-container"><h2>Afectaci√≥n x Tiempo</h2><div class="chart-box"><canvas id="cAfectacionDias"></canvas></div></div>
        <div class="tabla-critica">
            <h2 id="table-title">Backlog Activo</h2>
            <div class="table-wrapper">
                <table id="tSitios">
                    <thead><tr>
                        <th style="width:75px">ID</th>
                        <th style="width:110px">ALIADO</th>
                        <th style="width:70px; text-align:right;">D√çAS</th>
                        <th style="width:80px; text-align:right;">HORAS</th>
                        <th>STOPPER / GESTI√ìN ALIADO</th>
                    </tr></thead>
                    <tbody id="b-tabla"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let dataFull = []; let chart1, chartAfectacion; let selectedId = null; let historial = []; let currentDayFilter = null;
        const filtrosIds = {'f-regional': 'REGIONAL', 'f-depto': 'DEPARTAMENTO', 'f-aliado': 'ALIADO', 'f-topologia': 'TOPOLOGIA', 'f-tipo-operacion': 'PROYECTO', 'f-causa': 'motivo_falla'};

        async function init() {
            try { const res = await fetch('data_ben.json'); dataFull = await res.json(); actualizarSelectores(); aplicarCambios(false); } catch (e) { console.error(e); }
        }

        function showTooltip(e, item) {
            const tt = document.getElementById('tooltip-stopper');
            const val = item.STOPPER || "SIN STOPPER";
            const color = (val === "SIN STOPPER") ? "#e63946" : "#2a9d8f";
            tt.innerHTML = `
                <div style="border-bottom: 2px solid ${color}; padding-bottom: 5px; margin-bottom: 10px;">
                    <b style="color:${color}; font-size: 0.75rem;">ID: ${item.ID} | ${item.MUNICIPIO}</b>
                </div>
                <div style="font-weight: 600; color: #444;">${val}</div>
                <div style="margin-top: 10px; font-size: 0.7rem; color: #888; background: #f8f9fa; padding: 5px; border-radius: 5px;">
                    <b>Causa:</b> ${item.motivo_falla}
                </div>`;
            tt.style.display = 'block';
            let x = e.clientX + 20; let y = e.clientY + 20;
            if (x + 380 > window.innerWidth) x = e.clientX - 390;
            if (y + 180 > window.innerHeight) y = e.clientY - 190;
            tt.style.left = x + 'px'; tt.style.top = y + 'px';
        }
        function hideTooltip() { document.getElementById('tooltip-stopper').style.display = 'none'; }

        function buscarPorID() {
            const id = prompt("Ingrese el ID del sitio:");
            if (!id) return;
            const s = dataFull.find(i => String(i.ID) === id.trim());
            if (s) { registrarEstado(); seleccionarSitio(s.ID); } else { alert("El ID no existe en la base."); }
        }

        function registrarEstado() {
            const estado = { filtros: {}, selectedId, currentDayFilter };
            for (let id in filtrosIds) estado.filtros[id] = document.getElementById(id).value;
            historial.push(JSON.stringify(estado));
            document.getElementById('btn-return').disabled = false;
        }

        function registrarYFiltrar() { currentDayFilter = null; selectedId = null; registrarEstado(); aplicarCambios(false); }
        function filtrarPorRangoDias(r) { selectedId = null; registrarEstado(); currentDayFilter = r; aplicarCambios(false); }

        function aplicarCambios(conReg = true) {
            if (conReg) registrarEstado();
            const sel = {}; for (let id in filtrosIds) sel[filtrosIds[id]] = document.getElementById(id).value;
            
            let filtered = dataFull.filter(i => {
                if (sel.REGIONAL !== 'todos' && i.REGIONAL !== sel.REGIONAL) return false;
                if (sel.DEPARTAMENTO !== 'todos' && i.DEPARTAMENTO !== sel.DEPARTAMENTO) return false;
                if (sel.ALIADO !== 'todos' && i.ALIADO !== sel.ALIADO) return false;
                if (sel.TOPOLOGIA !== 'todos' && i.TOPOLOGIA !== sel.TOPOLOGIA) return false;
                if (sel.PROYECTO !== 'todos' && i.PROYECTO !== sel.PROYECTO) return false;
                
                const d = i.mttr_horas / 24;
                const isFalla = i.tickets > 0 && d >= 1;

                if (sel.motivo_falla !== 'todos' || currentDayFilter) {
                    if (!isFalla) return false;
                    if (sel.motivo_falla !== 'todos' && i.motivo_falla !== sel.motivo_falla) return false;
                    if (currentDayFilter) {
                        if (currentDayFilter === '>60' && d <= 60) return false;
                        if (currentDayFilter === '45-60' && (d < 45 || d > 60)) return false;
                        if (currentDayFilter === '30-45' && (d < 30 || d > 45)) return false;
                        if (currentDayFilter === '15-30' && (d < 15 || d > 30)) return false;
                        if (currentDayFilter === '5-15' && (d < 5 || d > 15)) return false;
                        if (currentDayFilter === '1-5' && (d < 1 || d > 5)) return false;
                    }
                }
                return true;
            });

            if (selectedId) filtered = filtered.filter(i => i.ID == selectedId);
            actualizarSelectores(); render(filtered);
        }

        function seleccionarSitio(id) {
            selectedId = id; const s = dataFull.find(i => i.ID == id);
            if (s) { for (let k in filtrosIds) { document.getElementById(k).value = s[filtrosIds[k]]; } }
            aplicarCambios(false);
            if(window.innerWidth < 1024) window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function pasoAtras() {
            if (historial.length === 0) return;
            const u = JSON.parse(historial.pop());
            for (let id in u.filtros) document.getElementById(id).value = u.filtros[id];
            selectedId = u.selectedId; currentDayFilter = u.currentDayFilter;
            actualizarSelectores(); aplicarCambios(false);
            if (historial.length === 0) document.getElementById('btn-return').disabled = true;
        }

        function actualizarSelectores() {
            const act = {}; for (let id in filtrosIds) act[id] = document.getElementById(id).value;
            for (let target in filtrosIds) {
                const unicos = [...new Set(dataFull.filter(i => {
                    for (let s in filtrosIds) { if (s !== target && act[s] !== 'todos' && i[filtrosIds[s]] !== act[s]) return false; }
                    return true;
                }).map(i => i[filtrosIds[target]]))].filter(v => v && v !== "N/A").sort();
                const el = document.getElementById(target); const prev = act[target];
                el.innerHTML = '<option value="todos">Todos</option>';
                unicos.forEach(v => el.add(new Option(v, v))); if (unicos.includes(prev)) el.value = prev;
            }
        }

        function render(data) {
            const sorted = data.sort((a, b) => b.mttr_horas - a.mttr_horas);
            let sD = 0, sH = 0, nF = 0, mC = {};
            let r_d = { '>60': 0, '45-60': 0, '30-45': 0, '15-30': 0, '5-15': 0, '1-5': 0 };

            sorted.forEach(s => {
                sD += s.disponibilidad; const d = s.mttr_horas / 24;
                if (s.tickets > 0 && d >= 1) {
                    nF++; sH += s.mttr_horas; mC[s.motivo_falla] = (mC[s.motivo_falla] || 0) + 1;
                    if (d > 60) r_d['>60']++; else if (d > 45) r_d['45-60']++; else if (d > 30) r_d['30-45']++; else if (d > 15) r_d['15-30']++; else if (d > 5) r_d['5-15']++; else r_d['1-5']++;
                }
            });

            document.getElementById('t-sitios').innerText = data.length;
            document.getElementById('d-global').innerText = (sD / (data.length || 1)).toFixed(1) + "%";
            document.getElementById('t-falla').innerText = nF;
            document.getElementById('m-promedio').innerText = (sH / (nF || 1)).toFixed(1) + "h";
            document.getElementById('d-promedio').innerText = (sH / (nF || 1) / 24).toFixed(1) + "d";

            const tb = document.getElementById('b-tabla'); tb.innerHTML = "";
            sorted.filter(s => s.tickets > 0 && (s.mttr_horas/24) >= 1).forEach(s => {
                const tr = document.createElement('tr'); if (s.ID == selectedId) tr.className = 'selected';
                tr.onmouseenter = (e) => showTooltip(e, s); tr.onmousemove = (e) => showTooltip(e, s); tr.onmouseleave = hideTooltip;
                tr.onclick = () => { hideTooltip(); registrarEstado(); seleccionarSitio(s.ID); };
                const st = s.STOPPER || "SIN STOPPER";
                tr.innerHTML = `<td>${s.ID}</td><td>${s.ALIADO}</td><td style="text-align:right;">${(s.mttr_horas/24).toFixed(1)}d</td><td style="text-align:right; font-weight:bold; color:var(--rojo)">${s.mttr_horas.toFixed(1)}h</td><td style="color:#555; font-style:italic">${st}</td>`;
                tb.appendChild(tr);
            });
            document.getElementById('table-title').innerText = selectedId ? `Filtro ID: ${selectedId}` : `Backlog Activo (${nF} sitios)`;
            actCharts(mC, r_d);
        }

        function actCharts(causas, r_d) {
            if(chart1) chart1.destroy(); if(chartAfectacion) chartAfectacion.destroy();
            const isMob = window.innerWidth < 1024;
            chart1 = new Chart(document.getElementById('cFallas'), {
                type: 'doughnut', data: { labels: Object.keys(causas), datasets: [{ data: Object.values(causas), backgroundColor: ['#0077b6', '#2a9d8f', '#f4a261', '#e76f51', '#264653', '#9b59b6'], borderWidth: 0 }] },
                options: { maintainAspectRatio: false, plugins: { legend: { position: isMob ? 'bottom' : 'right', labels: { boxWidth: 10, font: { size: 9 } }, onClick: (e, it) => { registrarEstado(); document.getElementById('f-causa').value = it.text; aplicarCambios(false); } }}}
            });
            chartAfectacion = new Chart(document.getElementById('cAfectacionDias'), {
                type: 'bar', data: { labels: ['>60 D√≠as', '45-60 D√≠as', '30-45 D√≠as', '15-30 D√≠as', '5-15 D√≠as', '1-5 D√≠as'], 
                datasets: [{ data: [r_d['>60'], r_d['45-60'], r_d['30-45'], r_d['15-30'], r_d['5-15'], r_d['1-5']], backgroundColor: ['#7f0000', '#B71C1C', '#D32F2F', '#E64A19', '#F9A825', '#B0BEC5'], borderRadius: 5 }] },
                options: { maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, onClick: (e, el) => { if(el.length > 0) filtrarPorRangoDias(['>60', '45-60', '30-45', '15-30', '5-15', '1-5'][el[0].index]); }}
            });
        }

        function exportarExcel() { 
            const tabla = document.getElementById('tSitios');
            const wb = XLSX.utils.table_to_book(tabla, {sheet: "Backlog"});
            XLSX.writeFile(wb, "Reporte_Backlog_Regional.xlsx"); 
        }
        init();
    </script>
</body>
</html>